<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Guest Clipboard Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-3">
      <div>
        <h1 class="text-2xl font-semibold">Guest List Clipboard Helper</h1>
        <p class="text-sm text-gray-600">One-click copy for invitation links & messages.</p>
      </div>
      <div class="flex items-center gap-2">
        <input id="searchInput" type="search" placeholder="Search name, ID, relation‚Ä¶" class="w-64 max-w-full px-3 py-2 border rounded-xl bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300" />
        <span id="countChip" class="bg-gray-100 text-xs px-2 py-0.5 rounded-full">0 guests</span>
      </div>
    </header>

    <!-- Nav -->
    <nav class="mb-4">
      <ul class="flex flex-wrap gap-2 text-sm">
        <li><a href="index.html" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white font-medium">Guests</a></li>
        <li><a href="report.html" class="px-3 py-1.5 rounded-lg bg-white border hover:bg-gray-50">Report</a></li>
      </ul>
    </nav>

    <!-- Quick Filters -->
    <section class="mb-4">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-sm text-gray-600">Relation:</span>
        <button class="rel-chip border border-blue-600 bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full text-xs" data-rel="">All</button>
        <button class="rel-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rel="alfon_relation">Alfon</button>
        <button class="rel-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rel="cindy_relation">Cindy</button>
        <button class="rel-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rel="alfon_parent_relation">Alfon's Parent</button>
        <button class="rel-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rel="cindy_parent_relation">Cindy's Parent</button>
      </div>
      <!-- RSVP Status Filter Chips -->
      <div class="flex flex-wrap gap-2 items-center mt-2">
        <span class="text-sm text-gray-600">RSVP status:</span>
        <button class="rsvp-chip border border-blue-600 bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full text-xs" data-rsvp="">All</button>
        <button class="rsvp-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rsvp="coming">Coming</button>
        <button class="rsvp-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rsvp="not_coming">Not Coming</button>
        <button class="rsvp-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-rsvp="no_respond">No Respond</button>
      </div>
      <!-- Invitation Filter Chips -->
      <div class="flex flex-wrap gap-2 items-center mt-2">
        <span class="text-sm text-gray-600">Invitation:</span>
        <button class="inv-to-chip border border-blue-600 bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full text-xs" data-inv="">All</button>
        <button class="inv-to-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-inv="reception">Reception</button>
        <button class="inv-to-chip border border-gray-300 bg-white text-gray-700 px-2.5 py-1 rounded-full text-xs" data-inv="holy_matrimony">Holy Matrimony</button>
      </div>
    </section>

    <!-- Table -->
    <section>
      <div class="bg-white border rounded-2xl shadow-sm overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr class="text-left">
              <th class="px-3 py-2 font-medium">ID</th>
              <th class="px-3 py-2 font-medium">Name</th>
              <th class="px-3 py-2 font-medium">Actions</th>
              <th class="px-3 py-2 font-medium">Type</th>
              <th class="px-3 py-2 font-medium">Relation</th>
              <th class="px-3 py-2 font-medium">RSVP</th>
              <th class="px-3 py-2 font-medium">Reserved Pax</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p class="text-xs text-gray-500 mt-2">Tip: Press <kbd>Ctrl</kbd>/<kbd>Cmd</kbd>+<kbd>K</kbd> to focus search.</p>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-4 px-3 py-2 rounded-xl bg-black/80 text-white text-sm shadow-lg opacity-0 pointer-events-none transition">Copied!</div>

  <script>
    // ===== CONFIG =====
    const isStaging = window.location.search.includes('staging=true');
    const BASE_URL = isStaging ? 'https://staging.alfoncindy.site' : 'https://www.alfoncindy.site';
    const DUE = '21 September 2025';
    const CSV_PATH = isStaging ? 'guest_staging_rows.csv' : 'guest_rows.csv';

    const navSuffix = isStaging ? '?staging=true' : '';
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('nav a').forEach(a => {
        const href = a.getAttribute('href');
        if (href) {
          // Remove any existing staging=true from the href
          let url = new URL(href, window.location.origin);
          url.searchParams.delete('staging');
          // If current page is staging, add it
          if (isStaging) {
            url.searchParams.append('staging', 'true');
          }
          a.setAttribute('href', url.pathname + (url.search ? url.search : ''));
        }
      });
    });

    // ===== Maps & formatters =====
    const RELATION_MAP = {
      'alfon_parent_relation': "Alfon's Parent",
      'cindy_parent_relation': "Cindy's Parent",
      'alfon_relation': 'Alfon',
      'cindy_relation': 'Cindy'
    };
    const TYPE_MAP = { 'reception': 'Reception', 'holy_matrimony': 'Holy Matrimony' };

    const formatRelation = (r) => RELATION_MAP[r] || (r ? r.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '');
    const formatType = (t) => TYPE_MAP[t] || (t ? t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '');

    // ===== DOM =====
    const $ = sel => document.querySelector(sel);
    const tbody = $('#tbody');
    const searchInput = $('#searchInput');
    const countChip = $('#countChip');

    // ===== Toast & Copy =====
    function showToast(msg) {
      const el = document.getElementById('toast');
      if (!el) return;
      el.textContent = msg;
      el.classList.remove('opacity-0');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.classList.add('opacity-0'), 1400);
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) {}
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.setAttribute('readonly','');
        ta.style.position = 'fixed'; ta.style.top = '-9999px';
        document.body.appendChild(ta); ta.focus(); ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta); return ok;
      } catch (e) {
        window.prompt('Copy this text:', text); return false;
      }
    }

    // ===== Message templating =====
    function regardsFor(rel, type){
      const r = String(rel||'').toLowerCase();
      if (r === 'alfon_parent_relation')
        return `Rudy Susanto Sudjono & Yosefin Paulina Sim\n(the proud parents of the groom)`;
      if (r === 'cindy_parent_relation')
        return type === 'holy_matrimony'
          ? `Niketius Hony Surjono & Auxilia Monika Pariva\n(the proud parents of the bride)`
          : `Hony Surjono & Monika Pariva\n(the proud parents of the bride)`;
      if (r === 'alfon_relation' || r === 'cindy_relation') return 'Alfon & Cindy';
      return 'Alfon & Cindy';
    }

    function buildLink(g) { return `${BASE_URL}/${encodeURIComponent(g.id)}`; }

    function buildMessage(g){
      const url = buildLink(g);
      const name = g.name;
      const type = g.invitation_type;
      if (type === 'holy_matrimony') {
        return `Dear ${name},\n\nWith hearts full of gratitude, we joyfully share the blessing that our beloved son\n\nVincentius Alfon Lavinski\nSon of Mr. Rudy Susanto Sudjono & Mrs. Yosefin Paulina Sim,\n\nwill soon unite in holy matrimony with\n\nEugenia Abigail Cindy Citrasari\nDaughter of Mr. Niketius Hony Surjono & Mrs. Auxilia Monika Pariva,\n\nüìÖ Saturday, 27 September 2025\nüïï 12:00 WIB\nüìç Gereja St. Andreas Kim Tae-gon, Kelapa Gading, Jakarta Utara\n\nIt would mean the world to us if you could join in this moment of joy,\nto witness their vows and shower them with your prayers.\n\nKindly confirm your attendance through the link below before ${DUE}\n${url}\n\nYour presence is not only an honor, but also a precious gift to our family.\n\nWith love and gratitude,\n${regardsFor(g.relation, type)}`;
      }
      return `Dear ${name},\n\nWith grateful hearts and joyful spirits,\nwe invite you to an evening of celebration honoring the marriage of\n\nAlfon Lavinski\nSon of Mr. Rudy Susanto Sudjono & Mrs. Yosefin Paulina Sim\n\nAnd\n\nEugenia Cindy Citrasari\nDaughter of Mr. Hony Surjono & Mrs. Monika Pariva.\n\nüìÖ Saturday, 27 September 2025\nüïñ 19:00 WIB\nüìç Gran Mahakam Hotel, Magnolia Ballroom\n\nMay this night be filled with warmth, laughter, and treasured memories, made even more special by your presence.\n\nKindly confirm your attendance through the link below before ${DUE}:\n${url}\n\nWarm Regards,\n${regardsFor(g.relation, type)}`;
    }

    // Normalize RSVP status to 3 buckets
    // function normStatus(s){
    //   const v = String(s || '').toLowerCase().trim();
    //   if (['coming','attending','yes','confirmed','datang'].includes(v)) return 'coming';
    //   if (['not_coming','not coming','declined','no','tidak datang','ga dateng','gak datang'].includes(v)) return 'not_coming';
    //   return 'no_respond';
    // }

    function statusLabel(g){
      // const s = normStatus(g.rsvp_status);
      const map = {
        coming:      { text: 'Coming',      cls: 'bg-green-100 text-green-800' },
        not_coming:  { text: 'Not Coming',  cls: 'bg-red-100 text-red-800' },
        no_respond:  { text: 'No Respond',  cls: 'bg-gray-100 text-gray-700' },
      };
      const { text, cls } = map[g.rsvp_status];
      return `<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${cls}">${text}</span>`;
    }

    // ===== Render =====
    function renderRows(list) {
      tbody.innerHTML = '';
      list.forEach((g) => {
        const tr = document.createElement('tr');
        tr.className = 'border-t align-top';
        const link = buildLink(g);
        const waText = buildMessage(g);
        // const nameCellMobileLink = `<div class="md:hidden mt-2"><a href="${link}" target="_blank" class="text-blue-600 underline break-all">Open link</a></div>`;
        tr.innerHTML = `
          <td class="px-3 py-2 align-top tabular-nums">${g.id ?? ''}</td>
          <td class="px-3 py-2 align-top">
            <a href="${link}" target="_blank" class="text-blue-600 underline">${g.name ?? ''}</a>
          </td>
          <td class="px-3 py-2 align-top w-48">
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full">
              <button class="bg-blue-600 hover:bg-blue-700 active:scale-95 text-white text-sm font-medium px-3 py-1.5 rounded-lg shadow w-full sm:w-auto" data-action="copy-link">Copy Link</button>
              <button class="bg-blue-600 hover:bg-blue-700 active:scale-95 text-white text-sm font-medium px-3 py-1.5 rounded-lg shadow w-full sm:w-auto" data-action="copy-wa">Copy WA Message</button>
            </div>
          </td>
          <td class="px-3 py-2 align-top">${formatType(g.invitation_type) ?? ''}</td>
          <td class="px-3 py-2 align-top">${formatRelation(g.relation) ?? ''}</td>
          <td class="px-3 py-2 align-top">${statusLabel(g)}</td>
          <td class="px-3 py-2 align-top">${g.rsvp_pax ?? '0'}</td>`;
        tbody.appendChild(tr);
        const [copyLinkBtn, copyWABtn] = tr.querySelectorAll('button');
        copyLinkBtn.addEventListener('click', async () => {
          const ok = await copyText(link); showToast(ok ? 'Link copied' : 'Copy shown');
        });
        copyWABtn.addEventListener('click', async () => {
          const ok = await copyText(waText); showToast(ok ? 'Message copied' : 'Copy shown');
        });
      });
      countChip.textContent = `${list.length} guest${list.length !== 1 ? 's' : ''}`;
    }

    let activeRelFilter = '';
    let activeRSVPFilter = '';
    let activeInvFilter = '';

    function applySearch(all) {
      const q = (searchInput?.value || '').trim().toLowerCase();
      let filtered = all || [];
      if (activeRelFilter) {
        filtered = filtered.filter(g => String(g.relation||'').toLowerCase() === activeRelFilter);
      }
      if (activeRSVPFilter) {
        filtered = filtered.filter(g => String(g.rsvp_status||'').toLowerCase() === activeRSVPFilter);
      }
      if (activeInvFilter) {
        filtered = filtered.filter(g => String(g.invitation_type||'').toLowerCase() === activeInvFilter);
      }
      if (q) {
        filtered = filtered.filter(g =>
          String(g.id).toLowerCase().includes(q) ||
          (g.name||'').toLowerCase().includes(q) ||
          (g.invitation_type||'').toLowerCase().includes(q) ||
          (g.relation||'').toLowerCase().includes(q)
        );
      }
      renderRows(filtered);
    }

    // ===== Load CSV =====
    fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: 'no-cache' })
      .then(res => res.ok ? res.text() : Promise.reject(new Error('CSV fetch failed ' + res.status)))
      .then(text => {
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true, transformHeader: h => h.replace(/\ufeff/g,'').trim() });
        const rows = parsed.data || [];
        const guests = rows.map(r => ({
          id: r.id,
          name: r.name,
          invitation_type: r.invitation_type,
          relation: r.relation,
          rsvp_status: r.rsvp_status,
          rsvp_pax: r.rsvp_pax || '0'
        })).filter(g => g.id && g.name);
        window.ALL = guests;
        applySearch(guests);
      })
      .catch(err => { console.error(err); showToast('Failed to load CSV'); renderRows([]); });

    // ===== Search input (debounced) =====
    function debounce(fn, ms=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }
    if (searchInput) {
      const run = debounce(()=>applySearch(window.ALL || []), 150);
      searchInput.addEventListener('input', run);
    }

    // ===== Quick relation filter =====
    document.querySelectorAll('.rel-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        activeRelFilter = (btn.dataset.rel || '').toLowerCase();
        document.querySelectorAll('.rel-chip').forEach(b=>{
          b.classList.remove('border-blue-600','bg-blue-50','text-blue-700');
          b.classList.add('border-gray-300','bg-white','text-gray-700');
        });
        btn.classList.remove('border-gray-300','bg-white','text-gray-700');
        btn.classList.add('border-blue-600','bg-blue-50','text-blue-700');
        applySearch(window.ALL || []);
      });
    });

    // RSVP status filter
    document.querySelectorAll('.rsvp-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        activeRSVPFilter = (btn.dataset.rsvp || '').toLowerCase();
        document.querySelectorAll('.rsvp-chip').forEach(b=>{
          b.classList.remove('border-blue-600','bg-blue-50','text-blue-700');
          b.classList.add('border-gray-300','bg-white','text-gray-700');
        });
        btn.classList.remove('border-gray-300','bg-white','text-gray-700');
        btn.classList.add('border-blue-600','bg-blue-50','text-blue-700');
        applySearch(window.ALL || []);
      });
    });

    // Invitation To filter
    document.querySelectorAll('.inv-to-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        activeInvFilter = (btn.dataset.inv || '').toLowerCase();
        document.querySelectorAll('.inv-to-chip').forEach(b=>{
          b.classList.remove('border-blue-600','bg-blue-50','text-blue-700');
          b.classList.add('border-gray-300','bg-white','text-gray-700');
        });
        btn.classList.remove('border-gray-300','bg-white','text-gray-700');
        btn.classList.add('border-blue-600','bg-blue-50','text-blue-700');
        applySearch(window.ALL || []);
      });
    });

    // Focus search with Cmd/Ctrl + K
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        searchInput?.focus();
        searchInput?.select();
      }
    });
  </script>
</body>
</html>
